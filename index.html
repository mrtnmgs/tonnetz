<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Tonnetz - Hackathon Sept 2022</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.42/Tone.js"
      integrity="sha512-jP8QvBXowc1rZhRvIR8Byb1ozO1xd41D3qwCCqgLObgPd4XXXh6Bws0gthw94jq0F8PWyGwIe+PaP0WJVihHZA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>

  <body>
    <div class="table"></div>
  </body>
  <script>
    const notes = [
      "c",
      "c#",
      "d",
      "d#",
      "e",
      "f",
      "f#",
      "g",
      "g#",
      "a",
      "a#",
      "b",
    ];

    function midiToNote(pitch) {
      // midi pitch to note name. C3 = MIDI 48 = "C"
      return notes[pitch % 12];
    }

    const table = document.querySelector(".table");

    // the horizontal axis has a 'linear' progression, going up in semitones
    // hence we build the lattice per row
    // rows are built bottom to top since we're going up in the musical scale
    // the first note of the next row (above is a third up, alternatively minor and major
    // visually it is offset to the right (major) or to the left (minor)

    let initialPitch = 21; // A0 for the first row
    initialPitch = 22;

    // create the rows
    // start at 1 bc used as multiplier
    for (let row = 1; row < 16; row++) {
      const rowEl = document.createElement("div");
      rowEl.classList.add("row", row % 2 ? "odd" : "even");

      // create the notes
      for (let note = 0; note < 7; note++) {
        const midiPitch = initialPitch + note;
        const noteName = midiToNote(midiPitch).toUpperCase();
        const noteNameOct = noteName + Math.floor(midiPitch / 12 - 1);
        const noteEl = document.createElement("button");
        noteEl.classList.add("note");
        noteEl.setAttribute("data-midi", midiPitch);
        noteEl.textContent = noteName;
        noteEl.addEventListener("click",() => play(noteNameOct));
        rowEl.append(noteEl);
      }
      table.prepend(rowEl);
      initialPitch += row % 2 ? 3 : 4; // next row goes up a third (alt min and major)
    }

    const monosynth = new Tone.PolySynth(Tone.MonoSynth, {
			volume: -8,
			oscillator: {
				type: "square8"
			},
			envelope: {
				attack: 0.05,
				decay: 0.3,
				sustain: 0.4,
				release: 0.8,
			},
			filterEnvelope: {
				attack: 0.001,
				decay: 0.7,
				sustain: 0.1,
				release: 0.8,
				baseFrequency: 300,
				octaves: 4
			}
		});


    function play(notes) {
      if (Tone.context.state !== 'running') {
        Tone.context.resume();
      }

      const poly = new Tone.PolySynth(Tone.Synth, {
        oscillator: {
          partials: [0],
        }
      }).toDestination();

      poly.triggerAttackRelease(notes, "8n");
    }

    const magic = 1.1547;
    const squareWidth = 100;
    const apothem = squareWidth / 2;
    const hexSide = magic * apothem;
    const rest = squareWidth - hexSide;
    const firstPoint = rest / 2;
    const secondPoint = firstPoint + hexSide;

    console.log(hexSide, rest, firstPoint, secondPoint);

    document.documentElement.style.setProperty('--a', firstPoint + "%"); 
    document.documentElement.style.setProperty('--b', secondPoint + "%"); 
  </script>
</html>
