<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Tonnetz - Hackathon Sept 2022</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.42/Tone.js"
      integrity="sha512-jP8QvBXowc1rZhRvIR8Byb1ozO1xd41D3qwCCqgLObgPd4XXXh6Bws0gthw94jq0F8PWyGwIe+PaP0WJVihHZA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>

  <body>
      <svg id="s" version="1.1"
        width="450" height="750"
        xmlns="http://www.w3.org/2000/svg">
      </svg>
  </body>
  <script>
    const notes = [
      "c",
      "c#",
      "d",
      "d#",
      "e",
      "f",
      "f#",
      "g",
      "g#",
      "a",
      "a#",
      "b",
    ];

    function midiToNote(pitch) {
      // midi pitch to note name. C3 = MIDI 48 = "C"
      return notes[pitch % 12];
    }

    /* the horizontal axis has a 'linear' progression, going up in semitones
    * hence we build the lattice per row
    * rows are built bottom to top since we're going up in the musical scale
    * the first note of the next row (above is a third up, alternatively minor and major
    * visually it is offset to the right (major) or to the left (minor)
    */

    function hexPoints(x, y, radius) {
      const points = [];
      for (let theta = 0; theta < Math.PI * 2; theta += Math.PI / 3) {
        let pointX, pointY;

        pointX = x + radius * Math.sin(theta);
        pointY = y + radius * Math.cos(theta);

        points.push(pointX + ',' + pointY);
      }

      return points.join(' ');
    }

    let x, y, row, col, pointX, pointY, theta;

    const radius = 50;
    const svg = document.getElementById('s');
    svg.setAttribute("width", radius * 2 * 7);
    svg.setAttribute("height", radius * 2 * 15);

    let basePitch = 22; // A#0 for the first row

    // SINGLE NOTES
    // create the rows
    // start at 1 bc used as multiplier
    let rowNotePitch = basePitch;
    const noteRadius = radius * 2/3;
    for (row = 1; row < 16; row ++) {
      const rowEl = document.createElementNS("http://www.w3.org/2000/svg", "g")
      rowEl.classList.add("note-row");
      for (col = 0; col < 7; col ++) {
        const midiPitch = rowNotePitch + col;
        const noteName = midiToNote(midiPitch).toUpperCase();
        const noteNameOct = noteName + Math.floor(midiPitch / 12 - 1);
        const offset = (Math.sqrt(3) * radius) / 2;
        x = 40 + offset * col * 2;
        y = (radius * 2 * 15) - (40 + offset * row * Math.sqrt(3));

        if (row % 2 !== 0) x += offset;

        const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
        group.classList.add("tile");
        group.addEventListener("click",() => play(noteNameOct));
        const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        polygon.style.fill = 'transparent';
        polygon.style.stroke = 'black';
        polygon.style.strokeWidth = '4px';
        polygon.setAttribute('points', hexPoints(x, y, noteRadius));
        polygon.setAttribute("data-midi", midiPitch);
        polygon.setAttribute("tabindex", "0");

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.textContent = noteName;
        text.setAttribute("x", x - 10);
        text.setAttribute("y", y + 5);
        group.appendChild(text);
        group.appendChild(polygon);
        rowEl.appendChild(group);
      }
      svg.appendChild(rowEl);
      rowNotePitch += row % 2 ? 3 : 4; // next row goes up a third (alt min and major)
    }

    const monosynth = new Tone.PolySynth(Tone.MonoSynth, {
			volume: -8,
			oscillator: {
				type: "square8"
			},
			envelope: {
				attack: 0.05,
				decay: 0.3,
				sustain: 0.4,
				release: 0.8,
			},
			filterEnvelope: {
				attack: 0.001,
				decay: 0.7,
				sustain: 0.1,
				release: 0.8,
				baseFrequency: 300,
				octaves: 4
			}
		});


    function play(notes) {
      if (Tone.context.state !== 'running') {
        Tone.context.resume();
      }

      const poly = new Tone.PolySynth(Tone.Synth, {
        oscillator: {
          partials: [0],
        }
      }).toDestination();

      poly.triggerAttackRelease(notes, "8n");
    }
  </script>
</html>
